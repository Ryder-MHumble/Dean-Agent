# DeanAgent 集成钉钉应用 + 钉钉机器人 可行性分析与实施方案

## Context

当前 DeanAgent 是一个纯前端 Next.js 16 应用，所有数据来自 mock 文件，没有后端 API、没有数据库、没有用户认证。用户希望将系统集成到钉钉生态中，实现：
1. 院长在系统中查看院内外信息
2. 院长指派任务 → 同步到钉钉机器人 → 机器人自动找到对应人通知
3. 机器人定时扫描各部门知识库 → 更新项目和科研成果数据

---

## 结论：整体可行，但有多个关键难点需要逐一攻克

这套方案**技术上完全可行**，钉钉开放平台提供了所需的全部 API 能力。但难度不在于「能不能做」，而在于「做好需要解决的工程问题」。下面逐一分析。

---

## 一、架构总览

```
┌─────────────────────────────────────────────────────────┐
│                    钉钉客户端                              │
│  ┌──────────────┐    ┌──────────────┐                    │
│  │  H5 微应用    │    │  钉钉机器人   │                    │
│  │ (DeanAgent)  │    │  (推送/交互)  │                    │
│  └──────┬───────┘    └──────┬───────┘                    │
└─────────┼───────────────────┼────────────────────────────┘
          │                   │
          ▼                   ▼
┌─────────────────────────────────────────────────────────┐
│              Next.js 后端 (API Routes)                    │
│  ┌────────────┐ ┌────────────┐ ┌─────────────────────┐  │
│  │ 钉钉Auth   │ │ 任务服务    │ │ 知识库同步服务        │  │
│  │ (免登/鉴权) │ │ (CRUD/派发) │ │ (定时扫描/数据处理)   │  │
│  └────────────┘ └────────────┘ └─────────────────────┘  │
│  ┌────────────┐ ┌────────────┐ ┌─────────────────────┐  │
│  │ 机器人消息   │ │ 通讯录服务  │ │ 数据聚合服务         │  │
│  │ (推送/回调)  │ │ (部门/人员) │ │ (外部情报/内部数据)   │  │
│  └────────────┘ └────────────┘ └─────────────────────┘  │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │   数据库       │
              │ (PostgreSQL)  │
              └───────────────┘
```

---

## 二、需要集成的钉钉 API 能力清单

| 能力 | 用途 | 钉钉API | 难度 |
|------|------|---------|------|
| **H5微应用免登** | 用户打开系统自动识别身份 | `dd.runtime.permission.requestAuthCode` | 低 |
| **JSAPI鉴权** | 调用钉钉客户端能力 | `dd.config` + 服务端签名 | 中 |
| **通讯录** | 获取部门/人员信息，用于任务指派 | `/v1.0/contact/users` | 低 |
| **待办任务** | 院长指派任务 → 创建钉钉待办 | `/v1.0/todo/users/{unionid}/tasks` | 中 |
| **机器人消息推送** | 主动通知指定人员 | 单聊: `/v1.0/robot/oToMessages/batchSend` | 中 |
| **机器人交互** | 接收用户回复和指令 | Stream模式/HTTP回调 | 中 |
| **知识库读取** | 扫描部门知识库内容 | 获取知识库API + 钉盘API | **高** |
| **事件订阅** | 监听任务状态变更等 | 事件订阅机制 | 中 |

---

## 三、六大核心难点深度分析

### 难点1: 从纯前端到全栈 — 后端架构从零构建

**现状**: 当前项目没有任何后端，所有数据来自 `lib/mock-data/`。

**需要构建的后端能力**:
- Next.js API Routes (`app/api/`) 作为 BFF 层
- 数据库 (PostgreSQL + Prisma ORM)
- 钉钉 AccessToken 管理 (有效期2小时，需缓存刷新)
- 定时任务调度器 (用于知识库扫描、数据聚合)
- 消息队列 (可选，用于异步任务处理)

**方案**: 利用 Next.js 自带的 Route Handlers 构建 API 层，避免引入额外的后端框架。数据库使用 PostgreSQL + Prisma。定时任务可通过外部 cron 服务 (如 Vercel Cron / 自建 node-cron) 触发。

### 难点2: 钉钉免登与身份打通

**挑战**: Next.js 默认是 SSR/SSG 应用，钉钉 JSAPI 依赖浏览器环境 (`window` 对象)。

**免登流程**:
```
钉钉客户端打开H5 → 前端调用 dd.requestAuthCode 获取 code
→ code 发送到我们的 API Route → API Route 用 code + AccessToken 换取 userId
→ 返回自己系统的 session/JWT → 完成登录
```

**关键注意点**:
- `dingtalk-jsapi` 必须在客户端动态导入 (`next/dynamic` 或 `useEffect` 内)
- URL 签名必须与当前页面 URL 严格一致（Next.js pathname 路由不受 # 号影响，这是优势）
- jsapi_ticket 有效期 7200 秒，需服务端缓存

### 难点3: 「自动找到对应的人」— 智能任务路由

**这是整个方案中最难的部分。**

院长指派任务时，可能说的是"让科研部跟进这个课题"或"通知张三处理"。要实现「自动找到对应的人」需要：

**方案A — 结构化指派 (推荐先行)**:
- 利用钉钉通讯录 API 获取组织架构 (部门树 + 人员列表)
- 在系统中构建「部门 → 负责人」映射表
- 院长指派时通过选择器指定：部门/人员 + 任务类型
- 系统根据映射自动定位到具体执行人

**方案B — AI 语义理解 (进阶)**:
- 接入 LLM 解析院长的自然语言指令
- 结合组织架构数据做实体识别 (人名、部门名、职务)
- 需要维护人员职责画像数据

**建议**: 先实现方案A（结构化选择），后续迭代方案B。

**钉钉待办任务创建参数**:
```typescript
// POST /v1.0/todo/users/{creatorUnionId}/tasks
{
  subject: "跟进XX课题进展",        // 任务标题
  description: "院长批示: ...",     // 任务描述
  executorIds: ["user_union_id"],  // 执行人
  participantIds: ["..."],         // 参与人
  dueTime: 1700000000000,         // 截止时间
  priority: 30,                    // 紧急程度 (10/20/30/40)
  detailUrl: {
    appUrl: "https://your-app/task/123",  // 移动端详情页
    pcUrl: "https://your-app/task/123"    // PC端详情页
  }
}
```

### 难点4: 知识库定时扫描与数据提取

**挑战**: 钉钉知识库 API 的开放程度有限，且数据格式多样。

**钉钉提供的知识库相关能力**:
- 获取知识库列表 API
- 钉盘文件读取 API
- 文档空间 API

**难点在于**:
1. **数据格式差异**: 知识库中可能有文档、表格、图片、PDF 等多种格式，解析逻辑复杂
2. **增量同步**: 需要识别哪些内容是新增/更新的，避免全量扫描
3. **内容理解**: 从原始文档中提取「项目进展」「科研成果」等结构化信息，需要 NLP/LLM
4. **权限控制**: 不同部门的知识库可能有不同访问权限

**方案**:
```
定时任务 (每日/每周)
  → 调用知识库 API 获取各部门文档列表
  → 对比上次扫描记录，识别增量
  → 下载/读取新增文档内容
  → 调用 LLM 提取关键信息 (项目名、进展、成果、负责人)
  → 存入数据库，更新系统内的「内部管理」模块数据
  → 生成变更摘要，通过机器人推送给院长
```

**替代方案**: 使用钉钉 AI 助理的知识库集成能力，让钉钉 AI 助理直接关联各部门知识库，通过 AI 助理的 API 来获取结构化信息，降低自建解析逻辑的复杂度。

### 难点5: 机器人消息设计与交互

**消息类型选择**:
| 场景 | 推荐消息类型 | 原因 |
|------|-------------|------|
| 任务通知 | 互动卡片 (ActionCard) | 支持按钮操作（接受/拒绝/查看详情）|
| 日报推送 | Markdown 消息 | 格式丰富，阅读体验好 |
| 紧急告警 | 文本 + @指定人 | 直接醒目 |
| 进度汇报 | 互动卡片 | 支持展开详情和操作按钮 |

**限制与注意**:
- 单聊机器人: 20条消息/分钟
- 批量发送需控制频率，避免触发限流
- Stream 模式支持流式输出 (适合 AI 对话场景)

### 难点6: 数据一致性与同步

**双向同步问题**:
- 院长在系统中创建任务 → 需同步到钉钉待办
- 执行人在钉钉中完成任务 → 需回调更新系统状态
- 知识库更新 → 需触发系统数据刷新

**方案**: 使用钉钉事件订阅机制，监听待办状态变更事件，通过 webhook 回调更新系统数据库。

---

## 四、分阶段实施路线

### Phase 1: 基础集成 (搭建后端 + 钉钉接入)
**目标**: 让系统能在钉钉内运行，实现身份打通

需要修改/新增的文件:
- `app/api/dingtalk/auth/route.ts` — 免登认证
- `app/api/dingtalk/config/route.ts` — JSAPI 鉴权签名
- `lib/services/dingtalk/token.ts` — AccessToken 管理
- `lib/services/dingtalk/crypto.ts` — 签名计算
- `middleware.ts` — 身份验证中间件
- 安装 `dingtalk-jsapi`, `@alicloud/dingtalk` SDK

### Phase 2: 任务系统 (指派 + 通知)
**目标**: 院长能指派任务，机器人自动通知对应人员

需要修改/新增的文件:
- `app/api/tasks/route.ts` — 任务 CRUD
- `app/api/dingtalk/robot/route.ts` — 机器人消息发送
- `app/api/dingtalk/contacts/route.ts` — 通讯录查询
- `lib/services/dingtalk/todo.ts` — 待办任务服务
- `lib/services/dingtalk/robot.ts` — 机器人消息服务
- `lib/services/dingtalk/contacts.ts` — 通讯录服务
- `components/modules/*/` — 改造现有页面，添加任务指派UI
- 数据库 schema: tasks, users, departments 表

### Phase 3: 知识库同步
**目标**: 定时扫描知识库，自动更新系统数据

需要修改/新增的文件:
- `app/api/sync/knowledge-base/route.ts` — 知识库同步触发
- `lib/services/dingtalk/knowledge.ts` — 知识库 API 封装
- `lib/services/sync/scanner.ts` — 增量扫描逻辑
- `lib/services/sync/parser.ts` — 文档内容解析
- Cron job 配置

### Phase 4: 智能化增强
**目标**: AI 辅助任务路由、自然语言指令、智能摘要

---

## 五、技术依赖与环境要求

| 依赖 | 说明 |
|------|------|
| 钉钉企业管理员权限 | 需要在钉钉开放平台创建企业内部应用 |
| 钉钉开放平台 AppKey/AppSecret | 应用身份凭证 |
| 服务器 (带公网IP/域名) | 钉钉回调需要公网可达的 HTTPS 地址 |
| PostgreSQL 数据库 | 存储任务、用户映射、同步记录等 |
| HTTPS 证书 | 钉钉要求所有接口使用 HTTPS |
| (可选) Redis | 缓存 AccessToken、jsapi_ticket |

---

## 六、风险与建议

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 知识库 API 开放程度不足 | 可能无法读取所有格式的文档内容 | 先调研 API 实际返回数据，必要时使用钉钉 AI 助理作为中间层 |
| 钉钉接口限流 (6000次/20秒) | 大批量操作可能被限制 | 实现请求队列和重试机制 |
| 免登在非钉钉环境不可用 | 开发调试困难 | 实现双模式: 钉钉环境用免登，浏览器环境用账密登录 |
| 组织架构变动 | 人员映射表过期 | 定期同步通讯录 + 事件订阅监听变更 |
| 文档格式多样性 | 解析质量参差不齐 | 先支持主流格式(文档/Markdown)，逐步扩展 |

---

## 七、验证方式

1. **H5微应用**: 在钉钉开发者后台创建测试应用，使用内网穿透工具 (如 ngrok) 将本地开发服务器暴露给钉钉
2. **机器人**: 先创建测试群，添加自定义机器人，验证消息推送
3. **待办任务**: 调用 API 创建测试待办，确认出现在钉钉客户端
4. **知识库**: 先用 API Explorer 测试知识库接口返回数据格式

---

## 参考资料

- [钉钉开放平台](https://open.dingtalk.com/)
- [钉钉开发文档](https://open.dingtalk.com/document/)
- [钉钉 API Explorer](https://open-dev.dingtalk.com/apiExplorer)
- [钉钉 API 总览](https://open.dingtalk.com/document/development/api-overview)
- [创建钉钉待办任务](https://open.dingtalk.com/document/development/add-dingtalk-to-do-task)
- [获取知识库 API](https://open.dingtalk.com/document/development/obtain-the-knowledge-base)
- [钉钉 H5 微应用开发](https://www.cnblogs.com/zhenjingcool/p/16896396.html)
- [钉钉 JSAPI 鉴权](https://blog.csdn.net/KLS_CSDN/article/details/144795171)
- [钉钉 GitHub 开源项目](https://github.com/open-dingtalk/)
- [阿里云百炼 + 钉钉 AI 机器人](https://help.aliyun.com/zh/model-studio/add-an-ai-assistant-to-your-dingtalk-in-10-minutes)
- [钉钉 IM 开放平台](https://imopen.dingtalk.com/)
